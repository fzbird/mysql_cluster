# ========================================================================
# HAProxy 配置文件 - MySQL 读写分离 (MySQL 8.0 优化版)
# ========================================================================

global
    # 全局配置
    daemon
    
    # 日志配置
    log stdout local0 info
    
    # 最大连接数
    maxconn 4096
    
    # 统计信息
    stats socket /tmp/haproxy.sock mode 666 level admin
    stats timeout 2m

defaults
    # 默认配置
    mode tcp
    timeout connect 10s
    timeout client 1m
    timeout server 1m
    timeout check 10s
    
    # 日志
    log global
    
    # 连接选项
    option redispatch
    retries 3

# 健康检查用户
userlist MYSQL_Health_Check
    user haproxy_check password check_password

# 统计页面
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats realm HAProxy\ MySQL\ Stats
    stats auth admin:admin123
    stats admin if TRUE

# MySQL 写操作前端（指向主服务器）
frontend mysql-write
    bind *:3308
    mode tcp
    default_backend mysql-master-backend
    
    # 日志
    capture request header Host len 32
    
    # 超时配置
    timeout client 1m

# MySQL 读操作前端（指向从服务器）
frontend mysql-read
    bind *:3309
    mode tcp
    default_backend mysql-slave-backend
    
    # 日志
    capture request header Host len 32
    
    # 超时配置
    timeout client 1m

# MySQL 主服务器后端（写操作）
backend mysql-master-backend
    mode tcp
    balance roundrobin
    
    # 超时配置
    timeout server 1m
    timeout connect 10s
    
    # 健康检查 (MySQL 8.0 优化)
    option mysql-check user haproxy_check post-41
    
    # 主服务器
    server mysql-master mysql-master:3306 check inter 5s fall 3 rise 2

# MySQL 从服务器后端（读操作）
backend mysql-slave-backend
    mode tcp
    balance roundrobin
    
    # 超时配置
    timeout server 1m
    timeout connect 10s
    
    # 健康检查 (MySQL 8.0 优化)
    option mysql-check user haproxy_check post-41
    
    # 从服务器（可以添加多个从服务器）
    server mysql-slave mysql-slave:3306 check inter 5s fall 3 rise 2
    
    # 如果从服务器不可用，可以回退到主服务器
    server mysql-master-backup mysql-master:3306 check inter 5s fall 3 rise 2 backup

# MySQL 智能路由前端（根据查询类型自动路由）
frontend mysql-smart
    bind *:3310
    mode tcp
    
    # 这里可以通过更复杂的规则来智能路由
    # 但由于HAProxy在TCP模式下无法解析SQL语句，
    # 建议应用层自己处理读写分离
    
    # 默认路由到主服务器
    default_backend mysql-master-backend 
